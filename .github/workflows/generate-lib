name: Generate Quarkus Lib

on:
  workflow_dispatch:
    inputs:
      artifact-id:
        description: 'Nome do repositório (artifact-id)'
        required: true

jobs:
  generate-repo:
    runs-on: ubuntu-latest

    steps:
      - name: Check if repository exists
        id: check-repo
        uses: actions/github-script@v6
        with:
          script: |
            const { data: repo } = await github.rest.repos.get({
              owner: context.repo.owner,
              repo: '${{ inputs.artifact-id }}'
            }).catch(() => ({ data: null }));
            if (repo) {
              core.setFailed(`Repositório ${{ inputs.artifact-id }} já existe na organização.`);
            }

      - name: Create new repository from template
        uses: actions/create-repo-from-template@v1
        with:
          template: 'lib-template'
          repo-name: '${{ inputs.artifact-id }}'
          owner: '${{ github.repository_owner }}'

      - name: Checkout new repository
        uses: actions/checkout@v3
        with:
          repository: '${{ github.repository_owner }}/${{ inputs.artifact-id }}'
          path: './${{ inputs.artifact-id }}'

      - name: Update group-id and artifact-id
        run: |
          cd ./${{ inputs.artifact-id }}
          ./gradlew renameProject -PnewGroupId=ceg.lib -PnewArtifactId=${{ inputs.artifact-id }}

      - name: Rename src folders
        run: |
          cd ./${{ inputs.artifact-id }}
          mkdir -p src/main/java/ceg/lib
          mv src/main/java/com/example/* src/main/java/ceg/lib/
          rm -rf src/main/java/com/example

      - name: Commit and push changes
        run: |
          cd ./${{ inputs.artifact-id }}
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Update group-id and artifact-id to ${{ inputs.artifact-id }}"
          git push origin main
